############################################################
##    FILENAME:   Util.py    
##    VERSION:    1.0
##    SINCE:      2014-04-15
##    AUTHOR: 
##        Jimmy Lin (xl5224) - JimmyLin@utexas.edu  
##
############################################################
##    Edited by MacVim
##    Documentation auto-generated by Snippet 
############################################################

import socket
from Protocol import *
import threading

__all__ = ['encode', 'decode', 'printLog', 'printRecvMessage', \
          'printSentMessage', 'initAllFalseCounter', 'initEmptySemaphore', \
          'send', 'broadcast', 'broadcastServers', 'checkCounterAllTrue', 'getPortByMsg' ]
printSwitch = True

def encode (st, si, rt, ri, title, content):
    '''
    API: encode the message by components
    '''
    msg = MESSAGE % (st, si, rt, ri, title, content)
    return msg

def decode (msg):
    ''' 
    API: Decode the message to various components
    '''
    components = msg.split(MESSAGE_SEP)
    sender_type = components[SENDER_TYPE_IDX];
    sender_index = int(components[SENDER_INDEX_IDX])
    receiver_type = components[RECEIVER_TYPE_IDX]
    receiver_idx = int(components[RECEIVER_INDEX_IDX])
    title = components[TITLE_IDX]
    content = components[CONTENT_IDX]
    return sender_type, sender_index, receiver_type, receiver_idx,\
            title, content

def printLog (toprint, logHeader):
    '''
    API: print log
    '''
    string = ""
    string += logHeader + " " + toprint
    if printSwitch:
        print string
    return

def printSentMessage (sentMessage, logHeader):
    '''
    API: send message
    '''
    if printSwitch:
        components = sentMessage.split(MESSAGE_SEP)
        receiver_type = components[RECEIVER_TYPE_IDX]
        receiver_idx = components[RECEIVER_INDEX_IDX]
        title = components[TITLE_IDX];
        content = components[CONTENT_IDX];

        string = "";
        string += logHeader + "send *" + title + "* to ";
        string += "{" + receiver_type + " #" + receiver_idx + "}: ";
        string += content
        print string
    return 

def printRecvMessage (recvMessage, logHeader):
    '''
    API: send message
    '''
    if printSwitch:
        components = recvMessage.split(MESSAGE_SEP)
        sender_type = components[SENDER_TYPE_IDX];
        sender_index = components[SENDER_INDEX_IDX];
        title = components[TITLE_IDX];
        content = components[CONTENT_IDX];

        string = "";
        string += logHeader + "|| Receive *" + title + "* from ";
        string += "{" + sender_type + " #" + sender_index + "}: ";
        string += content
        print string
    return 

def send (host, port, message, Header):
    '''
    API: send message
    '''
    s = socket.socket()
    s.connect((host, port))
    printSentMessage(message, Header)
    s.send(message)
    s.close()
    return True

def broadcastServers (host, sampleMsg, Header, allServers):
    '''
    API: broadcast message with $title$ to all given servers 
    with empty content
    '''
    st, si, _, _, title, content = decode (sampleMsg)

    #print allServers
    for serverIdx in allServers:
        msg = encode (st, si, SERVER_TYPE, serverIdx, title, content)
        port = getPortByMsg (msg)
        send (host, port, msg, Header)
    return True

def broadcast (host, sampleMsg, Header, allServers, allClients):
    '''
    API: broadcast message with $title$ to all given servers and clients
    with empty content
    '''
    st, si, _, _, title, content = decode (sampleMsg)

    #print allServers
    for serverIdx in allServers:
        msg = encode (st, si, SERVER_TYPE, serverIdx, title, content)
        port = getPortByMsg (msg)
        send (host, port, msg, Header)

    #print allClients
    for clientIdx in allClients:
        msg = encode (st, si, CLIENT_TYPE, clientIdx, title, content)
        port = getPortByMsg (msg)
        send (host, port, msg, Header)

    return True
    
def checkCounterAllTrue (boolCounter, NoneIgnore=True):
    '''
    API: determine whether the input array contains all boolean value
    '''
    assert (boolCounter is not None)
    decision = True
    for idx, bvalue in boolCounter.items():
        if bvalue == None and not NoneIgnore:
            decision = False
            break
        if not bvalue:
            decision = False
            break
    return decision

def initAllFalseCounter (allIndex):
    '''
    API: determine
    '''
    counter = {}
    for index in allIndex:
        counter.update({index:False})
    return counter

def getPortByMsg (msg):
    _, _, receiver_type, receiver_idx, _, _ = decode(msg)
    [base, port] = [-1, -1]
    if receiver_type == MASTER_TYPE:
        return MASTER_PORT
    elif receiver_type == SERVER_TYPE:
        base = SERVER_PORT_BASE
    elif receiver_type == CLIENT_TYPE:
        base = CLIENT_PORT_BASE
    port = base + receiver_idx
    return port

def initEmptySemaphore ():
    return threading.Semaphore(0)

def list2str (inList):
    outString = ','.join(inList)
    return outString

def str2list (inString):
    outList = [int(x) for x in inString.split(",")]
    return outList
